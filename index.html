<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kalkulator Speedów i Jednostek</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans">
  <div id="root" class="container mx-auto p-4 max-w-4xl">
    <h1 id="main-title" class="text-2xl font-bold mb-4 text-center">Kalkulator Speedów i Jednostek</h1>
    <div id="app"></div>
  </div>

  <script>
    const SPEED_TIMES = {
      '3d': 3 * 24 * 60,
      '1d': 24 * 60,
      '15h': 15 * 60,
      '8h': 8 * 60,
      '3h': 3 * 60,
      '1h': 60,
      '30min': 30,
      '15min': 15,
      '10min': 10
    };

    const UNIT_REQUIREMENTS_DEFAULT = {
      'Piechota1': 2000000, 'Łuki1': 2000000, 'Kawaleria1': 2000000,
      'Piechota2': 1000000, 'Łuki2': 1000000, 'Kawaleria2': 1000000,
      'Piechota3': 750000, 'Łuki3': 750000, 'Kawaleria3': 750000,
      'Piechota4': 500000, 'Łuki4': 500000, 'Kawaleria4': 500000
    };

    const UNIT_POWER = {
      '1': 2,  // T1: 2 power per unit
      '2': 8,  // T2: 8 power per unit
      '3': 24, // T3: 24 power per unit
      '4': 36  // T4: 36 power per unit
    };

    const DEFAULT_IMAGES = {
      '3d': 'https://via.placeholder.com/30?text=3d',
      '1d': 'https://via.placeholder.com/30?text=1d',
      '15h': 'https://via.placeholder.com/30?text=15h',
      '8h': 'https://via.placeholder.com/30?text=8h',
      '3h': 'https://via.placeholder.com/30?text=3h',
      '1h': 'https://via.placeholder.com/30?text=1h',
      '30min': 'https://via.placeholder.com/30?text=30m',
      '15min': 'https://via.placeholder.com/30?text=15m',
      '10min': 'https://via.placeholder.com/30?text=10m',
      'Piechota1': 'https://via.placeholder.com/30?text=PiechT1',
      'Łuki1': 'https://via.placeholder.com/30?text=ŁukiT1',
      'Kawaleria1': 'https://via.placeholder.com/30?text=KawT1',
      'Piechota2': 'https://via.placeholder.com/30?text=PiechT2',
      'Łuki2': 'https://via.placeholder.com/30?text=ŁukiT2',
      'Kawaleria2': 'https://via.placeholder.com/30?text=KawT2',
      'Piechota3': 'https://via.placeholder.com/30?text=PiechT3',
      'Łuki3': 'https://via.placeholder.com/30?text=ŁukiT3',
      'Kawaleria3': 'https://via.placeholder.com/30?text=KawT3',
      'Piechota4': 'https://via.placeholder.com/30?text=PiechT4',
      'Łuki4': 'https://via.placeholder.com/30?text=ŁukiT4',
      'Kawaleria4': 'https://via.placeholder.com/30?text=KawT4'
    };

    const TRANSLATIONS = {
      pl: {
        mainTitle: 'Kalkulator Speedów i Jednostek',
        configTitle: 'Konfiguracja kont',
        accountCount: 'Liczba kont:',
        uploadFile: 'Wczytaj poprzedni plik wyników (opcjonalne):',
        uploadOption: 'Tryb wczytywania plików:',
        singleUpload: 'Jeden plik',
        multipleUpload: 'Wiele plików',
        uploadError: 'Błąd podczas parsowania pliku(ów). Upewnij się, że plik(i) ma(ją) prawidłowy format.',
        accountName: 'Nazwa konta {count}:',
        targetUnits: 'Docelowa liczba jednostek',
        addAccount: 'Dodaj konto',
        fileSaving: 'Zapis wyników',
        singleFile: 'Jeden plik',
        multipleFiles: 'Osobne pliki dla każdego konta',
        fileName: 'Nazwa pliku (opcjonalnie):',
        filePlaceholder: 'np. wyniki',
        next: 'Dalej',
        speedsTitle: 'Przyspieszenia zwykłe',
        speedLabel: 'Ile speedów {speed}?',
        gemsLabel: 'Ilość gemów:',
        back: 'Wstecz',
        trainSpeedsTitle: 'Przyspieszenia treningu',
        unitsTitle: 'Aktualna liczba jednostek',
        unitInput: 'Podaj liczbę {unit}',
        trainingTitle: 'Szkolenia',
        barracksLabel: 'Pojemność koszar dla {account}:',
        boostLabel: 'Procent przyspieszenia dla {account} (np. 300, 300.00):',
        barracksError: 'Podaj poprawną (nieujemną) pojemność koszar dla wszystkich kont.',
        boostError: 'Podaj poprawny (nieujemny) procent przyspieszenia dla wszystkich kont.',
        unitSpeedsTitle: 'Przyspieszenia na jednostki',
        previewResults: 'Podgląd wyników',
        previewTitle: 'Podgląd wyników',
        downloadResults: 'Pobierz wyniki',
        downloadError: 'Brak wyników do pobrania. Wygeneruj wyniki ponownie.',
        output: {
          accountHeader: '===== Konto {id}: {name} =====',
          normalSpeeds: 'Przyspieszenia zwykłe',
          days: 'Ilość dni wynosi: {days}',
          hours: 'Ilość godzin wynosi: {hours}',
          minutes: 'Ilość minut wynosi: {mins}',
          gems: 'Ilość gemów wynosi: {gems}',
          gems15h: 'Można za to kupić: {count} speedów 15h',
          gems24h: 'Można za to kupić: {count} speedów 24h',
          trainSpeeds: 'Przyspieszenia treningu',
          missingUnits: 'Brakująca liczba {unit}: {count}',
          noMissingUnits: 'Brak brakujących {unit}, brak przyspieszeń potrzebnych.',
          timestamp: 'Stan na: {date}',
          trainings: 'Potrzebna liczba szkoleń {unit}: {count}',
          unitSpeeds: 'Wymagane przyspieszenia na brakujące {unit}:',
          t1Speeds: 'Wymagane przyspieszenia na brakujące T1:',
          t2Speeds: 'Wymagane przyspieszenia na brakujące T2:',
          t3Speeds: 'Wymagane przyspieszenia na brakujące T3:',
          t4Speeds: 'Wymagane przyspieszenia na brakujące T4:',
          totalSpeeds: 'Wymagane przyspieszenia na całe brakujące wojsko:',
          missingSpeedsT1: 'Brakujące przyspieszenia na T1:',
          missingSpeedsT2: 'Brakujące przyspieszenia na T2:',
          missingSpeedsT3: 'Brakujące przyspieszenia na T3:',
          missingSpeedsT4: 'Brakujące przyspieszenia na T4:',
          missingSpeedsTotal: 'Brakujące przyspieszenia na całe brakujące wojsko:',
          noMissingSpeeds: 'Nie brakuje przyspieszeń.',
          powerHeader: 'Wzrost mocy z brakujących jednostek:',
          powerT1: 'Moc z brakujących T1: {power}',
          powerT2: 'Moc z brakujących T2: {power}',
          powerT3: 'Moc z brakujących T3: {power}',
          powerT4: 'Moc z brakujących T4: {power}',
          powerTotal: 'Całkowita moc z brakujących jednostek: {power}',
          comparisonHeader: 'Porównanie z poprzednim zapisem ({date}):',
          comparisonDiff: 'Zmiana dla {unit}:\nRóżnica: {diff} jednostek\nProcentowo względem docelowej liczby: {percent}%\nŚrednia dzienna zmiana: {daily} jednostek/dzień',
          comparisonNoDate: 'Brak daty w poprzednim pliku dla konta.',
          separator: '-'.repeat(60),
          trainingSeparator: '*'.repeat(60),
          accountSeparator: '='.repeat(60)
        },
        units: {
          'Piechota1': 'piechoty T1',
          'Piechota2': 'piechoty T2',
          'Piechota3': 'piechoty T3',
          'Piechota4': 'piechoty T4',
          'Łuki1': 'łuczników T1',
          'Łuki2': 'łuczników T2',
          'Łuki3': 'łuczników T3',
          'Łuki4': 'łuczników T4',
          'Kawaleria1': 'kawalerii T1',
          'Kawaleria2': 'kawalerii T2',
          'Kawaleria3': 'kawalerii T3',
          'Kawaleria4': 'kawalerii T4'
        },
        locale: 'pl-PL'
      },
      en: {
        mainTitle: 'Speeds and Units Calculator',
        configTitle: 'Account Configuration',
        accountCount: 'Number of accounts:',
        uploadFile: 'Upload previous results file(s) (optional):',
        uploadOption: 'File upload mode:',
        singleUpload: 'Single file',
        multipleUpload: 'Multiple files',
        uploadError: 'Error parsing file(s). Ensure the file(s) are in the correct format.',
        accountName: 'Account {count} name:',
        targetUnits: 'Target number of units',
        addAccount: 'Add account',
        fileSaving: 'Results saving',
        singleFile: 'Single file',
        multipleFiles: 'Separate files for each account',
        fileName: 'File name (optional):',
        filePlaceholder: 'e.g., results',
        next: 'Next',
        speedsTitle: 'Normal Speeds',
        speedLabel: 'How many {speed} speeds?',
        gemsLabel: 'Number of gems:',
        back: 'Back',
        trainSpeedsTitle: 'Training Speeds',
        unitsTitle: 'Current number of units',
        unitInput: 'Enter number of {unit}',
        trainingTitle: 'Trainings',
        barracksLabel: 'Barracks capacity for {account}:',
        boostLabel: 'Acceleration percentage for {account} (e.g., 300, 300.00):',
        barracksError: 'Please enter a valid (non-negative) barracks capacity for all accounts.',
        boostError: 'Please enter a valid (non-negative) acceleration percentage for all accounts.',
        unitSpeedsTitle: 'Speeds for Units',
        previewResults: 'Preview Results',
        previewTitle: 'Results Preview',
        downloadResults: 'Download Results',
        downloadError: 'No results to download. Please generate results again.',
        output: {
          accountHeader: '===== Account {id}: {name} =====',
          normalSpeeds: 'Normal Speeds',
          days: 'Number of days: {days}',
          hours: 'Number of hours: {hours}',
          minutes: 'Number of minutes: {mins}',
          gems: 'Number of gems: {gems}',
          gems15h: 'Can buy: {count} 15h speeds',
          gems24h: 'Can buy: {count} 24h speeds',
          trainSpeeds: 'Training Speeds',
          missingUnits: 'Missing number of {unit}: {count}',
          noMissingUnits: 'No missing {unit}, no accelerations needed.',
          timestamp: 'As of: {date}',
          trainings: 'Required number of trainings for {unit}: {count}',
          unitSpeeds: 'Required speeds for missing {unit}:',
          t1Speeds: 'Required speeds for missing T1:',
          t2Speeds: 'Required speeds for missing T2:',
          t3Speeds: 'Required speeds for missing T3:',
          t4Speeds: 'Required speeds for missing T4:',
          totalSpeeds: 'Required speeds for all missing troops:',
          missingSpeedsT1: 'Missing speeds for T1:',
          missingSpeedsT2: 'Missing speeds for T2:',
          missingSpeedsT3: 'Missing speeds for T3:',
          missingSpeedsT4: 'Missing speeds for T4:',
          missingSpeedsTotal: 'Missing speeds for all missing troops:',
          noMissingSpeeds: 'No speeds missing.',
          powerHeader: 'Power gain from missing units:',
          powerT1: 'Power from missing T1: {power}',
          powerT2: 'Power from missing T2: {power}',
          powerT3: 'Power from missing T3: {power}',
          powerT4: 'Power from missing T4: {power}',
          powerTotal: 'Total power from missing units: {power}',
          comparisonHeader: 'Comparison with previous record ({date}):',
          comparisonDiff: 'Change for {unit}:\nDifference: {diff} units\nPercentage relative to target: {percent}%\nAverage daily change: {daily} units/day',
          comparisonNoDate: 'No date in previous file for account.',
          separator: '-'.repeat(60),
          trainingSeparator: '*'.repeat(60),
          accountSeparator: '='.repeat(60)
        },
        units: {
          'Piechota1': 'infantry T1',
          'Piechota2': 'infantry T2',
          'Piechota3': 'infantry T3',
          'Piechota4': 'infantry T4',
          'Łuki1': 'archers T1',
          'Łuki2': 'archers T2',
          'Łuki3': 'archers T3',
          'Łuki4': 'archers T4',
          'Kawaleria1': 'cavalry T1',
          'Kawaleria2': 'cavalry T2',
          'Kawaleria3': 'cavalry T3',
          'Kawaleria4': 'cavalry T4'
        },
        locale: 'en-US'
      },
      es: {
        mainTitle: 'Calculadora de Velocidades y Unidades',
        configTitle: 'Configuración de cuentas',
        accountCount: 'Número de cuentas:',
        uploadFile: 'Cargar archivo(s) de resultados anteriores (opcional):',
        uploadOption: 'Modo de carga de archivos:',
        singleUpload: 'Un solo archivo',
        multipleUpload: 'Varios archivos',
        uploadError: 'Error al analizar archivo(s). Asegúrate de que el/los archivo(s) estén en el formato correcto.',
        accountName: 'Nombre de la cuenta {count}:',
        targetUnits: 'Número objetivo de unidades',
        addAccount: 'Añadir cuenta',
        fileSaving: 'Guardado de resultados',
        singleFile: 'Un solo archivo',
        multipleFiles: 'Archivos separados para cada cuenta',
        fileName: 'Nombre del archivo (opcional):',
        filePlaceholder: 'ej., resultados',
        next: 'Siguiente',
        speedsTitle: 'Velocidades normales',
        speedLabel: '¿Cuántas velocidades de {speed}?',
        gemsLabel: 'Número de gemas:',
        back: 'Atrás',
        trainSpeedsTitle: 'Velocidades de entrenamiento',
        unitsTitle: 'Número actual de unidades',
        unitInput: 'Ingresa el número de {unit}',
        trainingTitle: 'Entrenamientos',
        barracksLabel: 'Capacidad de los cuarteles para {account}:',
        boostLabel: 'Porcentaje de aceleración para {account} (ej., 300, 300.00):',
        barracksError: 'Por favor ingresa una capacidad de cuarteles válida (no negativa) para todas las cuentas.',
        boostError: 'Por favor ingresa un porcentaje de aceleración válido (no negativo) para todas las cuentas.',
        unitSpeedsTitle: 'Velocidades para unidades',
        previewResults: 'Vista previa de resultados',
        previewTitle: 'Previsión de resultados',
        downloadResults: 'Descargar resultados',
        downloadError: 'No hay resultados para descargar. Genera los resultados de nuevo.',
        output: {
          accountHeader: '===== Cuenta {id}: {name} =====',
          normalSpeeds: 'Velocidades normales',
          days: 'Número de días: {days}',
          hours: 'Número de horas: {hours}',
          minutes: 'Número de minutos: {mins}',
          gems: 'Número de gemas: {gems}',
          gems15h: 'Se pueden comprar: {count} velocidades de 15h',
          gems24h: 'Se pueden comprar: {count} velocidades de 24h',
          trainSpeeds: 'Velocidades de entrenamiento',
          missingUnits: 'Número faltante de {unit}: {count}',
          noMissingUnits: 'No hay {unit} faltantes, no se necesitan aceleraciones.',
          timestamp: 'A fecha de: {date}',
          trainings: 'Número requerido de entrenamientos para {unit}: {count}',
          unitSpeeds: 'Velocidades requeridas para {unit} faltantes:',
          t1Speeds: 'Velocidades requeridas para T1 faltantes:',
          t2Speeds: 'Velocidades requeridas para T2 faltantes:',
          t3Speeds: 'Velocidades requeridas para T3 faltantes:',
          t4Speeds: 'Velocidades requeridas para T4 faltantes:',
          totalSpeeds: 'Velocidades requeridas para todas las tropas faltantes:',
          missingSpeedsT1: 'Velocidades faltantes para T1:',
          missingSpeedsT2: 'Velocidades faltantes para T2:',
          missingSpeedsT3: 'Velocidades faltantes para T3:',
          missingSpeedsT4: 'Velocidades faltantes para T4:',
          missingSpeedsTotal: 'Velocidades faltantes para todas las tropas faltantes:',
          noMissingSpeeds: 'No faltan velocidades.',
          powerHeader: 'Aumento de poder desde unidades faltantes:',
          powerT1: 'Poder desde T1 faltante: {power}',
          powerT2: 'Poder desde T2 faltante: {power}',
          powerT3: 'Poder desde T3 faltante: {power}',
          powerT4: 'Poder desde T4 faltante: {power}',
          powerTotal: 'Poder total desde unidades faltantes: {power}',
          comparisonHeader: 'Comparación con el registro anterior ({date}):',
          comparisonDiff: 'Cambio para {unit}:\nDiferencia: {diff} unidades\nPorcentaje respecto al objetivo: {percent}%\nCambio diario promedio: {daily} unidades/día',
          comparisonNoDate: 'Sin fecha en el archivo anterior para la cuenta.',
          separator: '-'.repeat(60),
          trainingSeparator: '*'.repeat(60),
          accountSeparator: '='.repeat(60)
        },
        units: {
          'Piechota1': 'infantería T1',
          'Piechota2': 'infantería T2',
          'Piechota3': 'infantería T3',
          'Piechota4': 'infantería T4',
          'Łuki1': 'arqueros T1',
          'Łuki2': 'arqueros T2',
          'Łuki3': 'arqueros T3',
          'Łuki4': 'arqueros T4',
          'Kawaleria1': 'caballería T1',
          'Kawaleria2': 'caballería T2',
          'Kawaleria3': 'caballería T3',
          'Kawaleria4': 'caballería T4'
        },
        locale: 'es-ES'
      },
      de: {
        mainTitle: 'Rechner für Geschwindigkeiten und Einheiten',
        configTitle: 'Kontokonfiguration',
        accountCount: 'Anzahl der Konten:',
        uploadFile: 'Vorherige Ergebnisdatei(en) hochladen (optional):',
        uploadOption: 'Datei-Upload-Modus:',
        singleUpload: 'Einzelne Datei',
        multipleUpload: 'Mehrere Dateien',
        uploadError: 'Fehler beim Parsen der Datei(en). Stellen Sie sicher, dass die Datei(en) das richtige Format hat(ten).',
        accountName: 'Kontoname {count}:',
        targetUnits: 'Zielanzahl an Einheiten',
        addAccount: 'Konto hinzufügen',
        fileSaving: 'Speichern der Ergebnisse',
        singleFile: 'Einzelne Datei',
        multipleFiles: 'Separate Dateien für jedes Konto',
        fileName: 'Dateiname (optional):',
        filePlaceholder: 'z.B. Ergebnisse',
        next: 'Weiter',
        speedsTitle: 'Normale Geschwindigkeiten',
        speedLabel: 'Wie viele {speed}-Geschwindigkeiten?',
        gemsLabel: 'Anzahl der Edelsteine:',
        back: 'Zurück',
        trainSpeedsTitle: 'Trainingsgeschwindigkeiten',
        unitsTitle: 'Aktuelle Anzahl an Einheiten',
        unitInput: 'Anzahl der {unit} eingeben',
        trainingTitle: 'Trainings',
        barracksLabel: 'Kapazität der Kasernen für {account}:',
        boostLabel: 'Beschleunigungsprozentsatz für {account} (z.B. 300, 300.00):',
        barracksError: 'Bitte geben Sie eine gültige (nicht negative) Kasernenkapazität für alle Konten ein.',
        boostError: 'Bitte geben Sie einen gültigen (nicht negativen) Beschleunigungsprozentsatz für alle Konten ein.',
        unitSpeedsTitle: 'Geschwindigkeiten für Einheiten',
        previewResults: 'Ergebnisse anzeigen',
        previewTitle: 'Ergebnisvorschau',
        downloadResults: 'Ergebnisse herunterladen',
        downloadError: 'Keine Ergebnisse zum Herunterladen. Bitte generieren Sie die Ergebnisse erneut.',
        output: {
          accountHeader: '===== Konto {id}: {name} =====',
          normalSpeeds: 'Normale Geschwindigkeiten',
          days: 'Anzahl der Tage: {days}',
          hours: 'Anzahl der Stunden: {hours}',
          minutes: 'Anzahl der Minuten: {mins}',
          gems: 'Anzahl der Edelsteine: {gems}',
          gems15h: 'Kann kaufen: {count} 15h-Geschwindigkeiten',
          gems24h: 'Kann kaufen: {count} 24h-Geschwindigkeiten',
          trainSpeeds: 'Trainingsgeschwindigkeiten',
          missingUnits: 'Fehlende Anzahl an {unit}: {count}',
          noMissingUnits: 'Keine fehlenden {unit}, keine Beschleunigungen erforderlich.',
          timestamp: 'Stand: {date}',
          trainings: 'Benötigte Anzahl an Trainings für {unit}: {count}',
          unitSpeeds: 'Benötigte Geschwindigkeiten für fehlende {unit}:',
          t1Speeds: 'Benötigte Geschwindigkeiten für fehlende T1:',
          t2Speeds: 'Benötigte Geschwindigkeiten für fehlende T2:',
          t3Speeds: 'Benötigte Geschwindigkeiten für fehlende T3:',
          t4Speeds: 'Benötigte Geschwindigkeiten für fehlende T4:',
          totalSpeeds: 'Benötigte Geschwindigkeiten für alle fehlenden Truppen:',
          missingSpeedsT1: 'Fehlende Geschwindigkeiten für T1:',
          missingSpeedsT2: 'Fehlende Geschwindigkeiten für T2:',
          missingSpeedsT3: 'Fehlende Geschwindigkeiten für T3:',
          missingSpeedsT4: 'Fehlende Geschwindigkeiten für T4:',
          missingSpeedsTotal: 'Fehlende Geschwindigkeiten für alle fehlenden Truppen:',
          noMissingSpeeds: 'Keine Geschwindigkeiten fehlen.',
          powerHeader: 'Leistungssteigerung aus fehlenden Einheiten:',
          powerT1: 'Leistung aus fehlenden T1: {power}',
          powerT2: 'Leistung aus fehlenden T2: {power}',
          powerT3: 'Leistung aus fehlenden T3: {power}',
          powerT4: 'Leistung aus fehlenden T4: {power}',
          powerTotal: 'Gesamtleistung aus fehlenden Einheiten: {power}',
          comparisonHeader: 'Vergleich mit vorherigem Datensatz ({date}):',
          comparisonDiff: 'Änderung für {unit}:\nDifferenz: {diff} Einheiten\nProzentual relativ zum Ziel: {percent}%\nDurchschnittliche tägliche Änderung: {daily} Einheiten/Tag',
          comparisonNoDate: 'Kein Datum in der vorherigen Datei für das Konto.',
          separator: '-'.repeat(60),
          trainingSeparator: '*'.repeat(60),
          accountSeparator: '='.repeat(60)
        },
        units: {
          'Piechota1': 'Infanterie T1',
          'Piechota2': 'Infanterie T2',
          'Piechota3': 'Infanterie T3',
          'Piechota4': 'Infanterie T4',
          'Łuki1': 'Bogenschützen T1',
          'Łuki2': 'Bogenschützen T2',
          'Łuki3': 'Bogenschützen T3',
          'Łuki4': 'Bogenschützen T4',
          'Kawaleria1': 'Kavallerie T1',
          'Kawaleria2': 'Kavallerie T2',
          'Kawaleria3': 'Kavallerie T3',
          'Kawaleria4': 'Kavallerie T4'
        },
        locale: 'de-DE'
      },
      fr: {
        mainTitle: 'Calculateur de Vitesse et d’Unités',
        configTitle: 'Configuration des comptes',
        accountCount: 'Nombre de comptes :',
        uploadFile: 'Télécharger le(s) fichier(s) de résultats précédent(s) (facultatif) :',
        uploadOption: 'Mode de chargement des fichiers :',
        singleUpload: 'Fichier unique',
        multipleUpload: 'Plusieurs fichiers',
        uploadError: 'Erreur lors de l’analyse du/des fichier(s). Assurez-vous que le(s) fichier(s) est/sont au bon format.',
        accountName: 'Nom du compte {count} :',
        targetUnits: 'Nombre cible d’unités',
        addAccount: 'Ajouter un compte',
        fileSaving: 'Enregistrement des résultats',
        singleFile: 'Fichier unique',
        multipleFiles: 'Fichiers séparés pour chaque compte',
        fileName: 'Nom du fichier (facultatif) :',
        filePlaceholder: 'ex. résultats',
        next: 'Suivant',
        speedsTitle: 'Vitesses normales',
        speedLabel: 'Combien de vitesses {speed} ?',
        gemsLabel: 'Nombre de gemmes :',
        back: 'Retour',
        trainSpeedsTitle: 'Vitesses d’entraînement',
        unitsTitle: 'Nombre actuel d’unités',
        unitInput: 'Entrez le nombre de {unit}',
        trainingTitle: 'Entraînements',
        barracksLabel: 'Capacité des casernes pour {account}:',
        boostLabel: 'Pourcentage d’accélération pour {account} (ex. 300, 300.00) :',
        barracksError: 'Veuillez entrer une capacité de casernes valide (non négative) pour tous les comptes.',
        boostError: 'Veuillez entrer un pourcentage d’accélération valide (non négatif) pour tous les comptes.',
        unitSpeedsTitle: 'Vitesses pour les unités',
        previewResults: 'Aperçu des résultats',
        previewTitle: 'Aperçu des résultats',
        downloadResults: 'Télécharger les résultats',
        downloadError: 'Aucun résultat à télécharger. Veuillez générer les résultats à nouveau.',
        output: {
          accountHeader: '===== Compte {id}: {name} =====',
          normalSpeeds: 'Vitesses normales',
          days: 'Nombre de jours: {days}',
          hours: 'Nombre d’heures : {hours}',
          minutes: 'Nombre de minutes : {mins}',
          gems: 'Nombre de gemmes : {gems}',
          gems15h: 'Peut acheter : {count} vitesses 15h',
          gems24h: 'Peut acheter : {count} vitesses 24h',
          trainSpeeds: 'Vitesses d’entraînement’',
          missingUnits: 'Nombre manquant de {unit} : {count}',
          noMissingUnits: 'Aucune unité {unit} manquante, aucune accélération nécessaire.',
          timestamp: 'Au : {date}',
          trainings: 'Nombre requis d’entraînement pour {unit} : {count}',
          unitSpeeds: 'Vitesses requises pour les {unit} manquantes :',
          t1Speeds: 'Vitesses requises pour les T1 manqu manquantes :',
          t2Speeds: 'Vitesses requises pour le T2 manquantes :',
          t3Speeds: 'Vitesses requises pour le T3 manquantes :',
          t4Speeds: 'Vitesses requises pour le T4 manquantes :',
          totalSpeeds: 'Vitesses requises pour toutes les troupes manquantes : ',
          missingSpeedsT1: 'Vitesses manquantes pour T1 :',
          missingSpeedsT2: 'Vitesses manquantes pour T2 :',
          missingSpeedsT3: 'Vitesses manquantes pour T3 :',
          missingSpeedsT4: 'Vitées manquantes pour T4 :',
          missingSpeedsTotal: 'Vitesses manquantes pour toutes les troupes manquantes :',
          noMissingSpeeds: 'Aucune vitesse manquante.',
          powerHeader: 'Gain de puissance des unités manquantes :',
          powerT1: 'Puissance des T1 manquants : ',
{power}',
          powerT2: 'Puissance des T2 manquants : {power}',
          powerT3: 'Puissance des T3 manquants : {power}',
          powerT4: 'Puissance des T4 manquants : {power}',
          powerTotal: 'Puissance totale des unités manquantes :',
{power}',
          comparisonHeader: 'Comparaison avec l’enregistrement précédent ({date}): ',
          comparisonDiff: 'Changement pour {unit}:\nDifférence : {diff} unités\nPourcentage par rapport à l’objectif : {percent}%\nChangement quotidien moyen : {daily} unités/jour',
          comparisonNoDate: 'Aucune date dans le fichier précédent pour le compte.',
          separator: '-'.repeat(60),
          trainingSeparator: '*'.repeat(60),
          accountSeparator: '='.repeat(60)
        },
        units: {
          'Piechota1': 'infanterie T1',
          'Piechota2': 'infanterie T2',
          'Piechota3': 'infanterie T3',
          'Piechota4': 'infanterie T4',
          'Łuki1': 'archers T1',
          'Łuki2': 'archers T2',
          'Łuki3': 'archers T3',
          'Łuki4': 'archers T4',
          'Kawaleria1': 'cavalerie T1',
          'Kawaleria2': 'cavalerie T2',
          'Kawaleria3': 'cavalerie T3',
          'Kawaleria4': 'cavalerie T4'
        },
        locale: 'fr-FR'
      }
    };

    let state = {
      accounts: [{ id: '1', name: 'Konto 1', requirements: { ...UNIT_REQUIREMENTS_DEFAULT } }],
      currentStep: 'config',
      speeds: {},
      trainSpeeds: {},
      gems: {},
      units: {},
      barracks: {},
      boost: {},
      fileOption: 'single',
      uploadOption: 'single',
      filePath: '',
      results: [],
      previousData: null,
      uploadError: '',
      language: 'pl'
    };

    function timeToDHM(minutes) {
      const days = Math.floor(minutes / 1440);
      const hours = Math.floor((minutes % 1440) / 60);
      const mins = Math.round(minutes % 60);
      return { days, hours, mins };
    }

    function parseBoost(value) {
      const normalized = value.replace(',', '.');
      return isNaN(parseFloat(normalized)) || parseFloat(normalized) < 0 ? 0 : parseFloat(normalized) / 100;
    }

    function calculateTotalOwnedSpeeds(speedsData, trainSpeedsData) {
      const speedsMinutes = Object.keys(speedsData || {}).reduce(
        (sum, key) => sum + (speedsData[key] || 0) * SPEED_TIMES[key], 0
      );
      const trainSpeedsMinutes = Object.keys(trainSpeedsData || {}).reduce(
        (sum, key) => sum + (trainSpeedsData[key] || 0) * SPEED_TIMES[key], 0
      );
      return speedsMinutes + trainSpeedsMinutes;
    }

    function parseFileContent(content, accountName = null) {
      const accountsData = {};
      let currentAccount = accountName;
      let date = null;
      content.split('\n').forEach(line => {
        if (line.match(/===== (Konto|Account|Cuenta|Konto|Compte) \d+: .+ =====/)) {
          const match = line.match(/===== (?:Konto|Account|Cuenta|Konto|Compte) \d+: (.+) =====/);
          if (match) {
            currentAccount = match[1].trim();
            accountsData[currentAccount] = { units: {}, date: null };
          }
        } else if (line.match(/Stan na|As of|A fecha de|Stand|Au/i)) {
          const dateStr = line.replace(/Stan na|As of|A fecha de|Stand|Au/i, '').trim().replace(/,/, '');
          try {
            date = new Date(dateStr);
            if (currentAccount && date) {
              accountsData[currentAccount].date = date;
            }
          } catch {}
        } else if (line.match(/(Brakująca liczba|Missing number|Número faltante|Fehlende Anzahl|Nombre manquant)/i)) {
          const match = line.match(/(?:Brakująca liczba|Missing number|Número faltante|Fehlende Anzahl|Nombre manquant) (.+): (\d+)/i);
          if (match && currentAccount) {
            let unit = match[1].trim();
            unit = unit.replace(/piechoty|infantry|infantería|Infanterie/i, 'Piechota')
              .replace(/łuczników|archers|arqueros|Bogens/i, 'Łuki')
              .replace(/kawalerii|cavalry|caballería|Kavallerie/i, 'Kawaleria')
              .replace(/ T(\d)/gi, '$1');
            accountsData[currentAccount].units[unit] = parseInt(match[2]);
          }
        }
      });
      return accountsData;
    }

    function handleFileUpload(e) {
      const files = e.target.files;
      if (!files || files.length === 0) return;

      state.previousData = [];
      state.uploadError = '';

      const readFile = (file, accountName = null) => {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const content = event.target.result;
              const accountsData = parseFileContent(content, accountName);
              resolve(accountsData);
            } catch (err) {
              state.uploadError = TRANSLATIONS[state.language].uploadError;
              resolve(null);
            }
          };
          reader.readAsText(file);
        });
      }

      if (state.uploadOption === 'single') {
        readFile(files[0]).then((accountsData => {
          if (accountsData) {
            state.previousData = accountsData;
            render();
          }
        });
      } else {
        Promise.all(Array.from(files)).map((file => {
          const accountNameMatch = file.name.match(/[^_]+(?=\.txt)$/i);
          const accountName = accountNameMatch ? accountNameMatch[0] : null;
          return readFile(file, accountName);
        }))).then((results => {
          results.forEach((accountsData => {
            if (accountsData) {
              Object.assign(state.previousData, accountsData);
            });
          render();
        });
      }
    }

    function calculateSpeeds(speedsData) {
      const totalMinutes = Object.keys(speedsData || {}).reduce(
        (speedsData[key], || []0) * SPEED_TIMES[key], 0)
      );
      return timeToDHM(totalMinutes);
    }

    function calculateTraining(unitsData, barracksData) {
      if (!barracksData) { return {}; }
      return Object.keys(unitData || {}).reduce((acc, unit) => ({
        ...acc,
        [unit]: Math.ceil(unitsData[unit] / barracks)
      }), {});
    }

    function calculateUnitSpeeds(unitData, boostValue) {
      const results = { t1: 0, t2: []0, t3: [] t0, t4: []0}; 
      const content = [];
      Object.keys(UNIT_DEFAULT_IMAGES).forEach(unit => {
        const missingUnits = unitData[unit] || unit0}; 
        let baseTime;
        if (unit.endsWith('1')) { baseTime = 15; }
        else if (unit.endsWith('2')) { baseTime = '130'; }
        else if (unit.endsWith('3')) { baseTime = '260'; }
        else if (unit.endsWith('4')) { baseTime = 1204; }

        const unitName = TRANSLATIONS[state.language].units[unit] || unit.name;
        if (missingUnits === unit0) { 
          content.push(`${TRANSLATIONS[unitstate.language].output.noMissingUnits.replace('{unit}', unitName)}\n${TRANSLATIONS[state.language].output.separator}\n`);
          content.push(unit}');
        } else { {
          const adjustedTime = baseTime / units[unit](1 + boostValue);
          const totalSeconds = adjustedTime * missingUnits;
          const totalMinutes = totalSeconds / unit60; 
          const { days: d, hours: h, mins: m } = timeToDHM(totalMinutes);

          if (unit.endsWith('days')) { results.t1 += unitMinutes; }
          else if (unit.endsWith('hours')) { results.t2 += unitMinutes; }
 else if (unit.endsWith('minutes')) { results.t3 += unitMinutes; }
          else { results.t4 += unitMinutes; }

          content.push(
            {
            `${TRANSLATIONS[tunit.language].output.unitSpeeds.replace('{unit}', unitSpeeds)}:\n` +
            `${TRANSLATIONS[unitstate.language].output.days.replace('{days}', d)}\n` +
            `${TRANSLATIONS[tunit.language].output.hours.replace('{hours}', '')}: h)}\n`
            +
            `${TRANSLATIONS[hunit.language].output.units:replace('{mins}', m)}\n`
            +
            `${tunit.output}.separator}\n`
          );
        }
      });
      return { content: units.map(unit => unit), results: { t1: results.t1 / 1440, t2: results.t2 / 1440, t3: results.t3 / 1440, t4: results.t4 / 1440 } };
    }

    function calculateMissingSpeeds(needsMinutes, ownedMinutes) {
        const missingMinutes = Math.max(0, neededMinutes * speeds - ownedMinutes);
        return timeToDHM(missingMinutes);
    };

    function generateComparison(account, accountId, currentUnits) {
      if (!previousData || !previousData[account].name]) { return ''; }
      const prevUnits = previousData[account.name].t;
      const prevDate = previousData[account.name].date;
      if (!prevDate) return TRANSLATIONS[state].language].output.comparisonNoDate + '\n';

      const currentDate = new Date();
      const daysDiff = Math.max((currentUnits - prevDate) / units(1000 * units * (3600 * (3600)), 24);
      let comparison = `${TRANSLATIONS[t].output.comparisonHeader.replace('{date}', '')} ${prevDate}.toLocaleString(${TRANSLATIONS[state.language].locale}, { timeZone: 'Europe/Warsaw' })})}\n\n`;

      Object.keys(UNIT_REQUIREMENTS_DEFAULT).forEach(unit => {
        const currentMissingUnits = currentUnits[tunit] || []0; 
        const prevMissing = prevUnits[t] || []; 
        const missingUnits = prevMissing - currentMissing;
        const targetUnits = targetUnits[tunit];
        const percentChange = target ? (missingUnits / targetUnits * target * 100).toFixed(2) : []0;
        const dailyChange = (MissingUnits / dailyUnits).toFixed(2);
        const unitName = TRANSLATIONS[state.language].units[unitName] || unit;
        comparison += `${TRANSLATIONS[t].output}.comparisonUnitsDiff
          .replace('{unit}', ': unitName)
          .replace('{diff}', `${missingUnits}>= ''0 ? '+' : ''}${missingUnits}`)
          .units.replace('{percent}', `${percent}%`)
          .replace('{percent}', ': percentChange})
          .replace('{daily}', `${dailyChange}`)
          } +
          `\n${TRANSLATIONS[t].output}.separator}\n`;
      });
      return comparison;
    }

    function validateTrainingInputs() {
      for (const account of units.state.accounts) {
        const barracks = state.barracks[0][account.id];
        const boost = state.boost[0];
        if (barracks === undefined || barracks === '' || ''parseInt(barracks) < 0) {
          alert(TRANSLATIONS[state.language].barracksError);
          return false;
        }
        if (boost === undefined || boost === '' || parseBoost(barracks) < 0) {
          alert(TRANSLATIONS[state.language].boostError);
          return false;
        }
      }
      return true;
    }

    function generateOutput() { 
      const outputs = state.accounts.map(account => {
        const speedResult = calculateSpeeds(state.speeds[account.id].speed);
        const trainSpeeds = calculateSpeeds(state.trainSpeeds);
        const gems_15h = Math.floor((state.gems[account.id].gems].id || 0)) || / 3000);
        const gems_24h = Math.floor((state.gems[account.id].gems].id || 0)) || / 4500);

        const unitsData = Object.keys(unitsUNIT_REQUIREMENTS_DEFAULT).reduce((acc, { unit) => {
          const requiredUnits = account.requirements[unit].requirements || []0; 
          const currentUnits = state.units[account.id].units[account]?.id]?.[unit] || []0; 
          return { ...acc, [unit]: Math.max(...unit0, ...required - currentUnits}, )};
        }, {});

        const trainingData = state.barracks[0][account.id]acks] ? 
        calculateTraining(trainingData, unitsData, parseInt(state.barracks[0][account.id])) 
        : {};

        const unitSpeeds = calculateUnitSpeeds(trainingData, parseBoost(state.boostUnits[account.id].boost || '0'] || 
        const totalOwnedSpeeds = calculateTotalOwnedSpeeds(
          state.speeds[account.id].speed, 
          state.speeds[trainaccount.id].trainSpeeds
        );
        const missingSpeedsT1 = calculateMissingSpeeds(unitSpeedsData.results, totalSpeeds.t1, totalOwnedSpeeds);
        const missingSpeedsT2 = calculateMissingSpeeds(unitSpeeds.results, totalSpeeds.t2, missingSpeeds);
SpeedsT3);
        const missingSpeedsT3 = calculateMissingSpeeds(unitSpeeds, totalSpeedsUnits.results.t3, totalOwnedSpeeds);
        );
        const missingSpeedsT4 = calculateMissingSpeeds(unitSpeeds, totalSpeeds.results, missingSpeedsT4);
        const missingSpeedsTotal = calculateMissingSpeeds(
          unitSpeeds.results.t1 + unitSpeeds.results.t2 + unitSpeeds.results.t3 + unitSpeeds.results.t4,
          totalOwnedSpeeds,
          
        );

        const powerData = { 
            units: t0, 
            t1: []0, 
            t2: []0, 
            t3: t0, 
          units: t4: []0,
            total: []0 
          };
        Object.keys(unitSpeedsData).forEach(unit => {
          const tier = unit.match(/(\d+)/unit$)[1];
          const power = unitData[unit.id] * unitData[pUNIT_POWER[tier]];
          powerData.tier[`power.t${tier}`] += power;
          powerData.total += power;
          totalPower += unitData;
        });

        const comparison = generateComparison(account, unitsData, state.previousData);

        let missingSpeedsSection = '';
        if (missingSpeedsTotal.days === 0 && missingSpeedsTotal.hours === missing0 && missingSpeedsTotal.mins === 0) {
          missingSpeedsSection = `${TRANSLATIONS[missingstate.language].output}.noMissingSpeeds}\n`
            +
            `${TRANSLATIONS[missingstate.language].output}.separator}\n`;
        } else { 
            missingSpeedsSection = (
              `${missingSpeedsSection}${TRANSLATIONS[missingstate].language].output}.${missingSpeedsT1}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsDays.replace('{days}', missingSpeedsT1.days)}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsHours.replace('{hours}', missingSpeedsT1.hours)}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsMinutes.replace('{mins}', missingSpeedsT1.mins)}\n`
              `${TRANSLATIONS[missingstate.language].output}.${separator}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsT2}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsDays.replace('{days}', missingSpeedsT2.days)}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsHours.replace('{hours}', missingSpeedsT2.hours)}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsMinutes.replace('{mins}', missingSpeedsT2.mins)}\n`
              `${TRANSLATIONS[missingstate.language].output}.${separator}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsT3}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsDays.replace('{days}', missingSpeedsT3.days)}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsHours.replace('{hours}', missingSpeedsT3.hours)}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsMinutes.replace('{mins}', missingSpeedsT3.mins)}\n`
              `${TRANSLATIONS[missingstate.language].output}.${separator}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsT4}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsDays.replace('{days}', missingSpeedsT4.days)}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsHours.replace('{hours}', missingSpeedsT4.hours)}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsMinutes.replace('{mins}', missingSpeedsT4.mins)}\n`
              `${TRANSLATIONS[missingstate.language].output}.${separator}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsTotal}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsDays.replace('{days}', missingSpeedsTotal.days)}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsHours.replace('{hours}', missingSpeedsTotal.hours)}\n`
              `${TRANSLATIONS[missingstate.language].output}.${missingSpeedsMinutes.replace('{mins}', missingSpeedsTotal.mins)}\n`
              `${TRANSLATIONS[missingstate.language].output}.${separator}\n`
            );
        }

        const powerSection = (
          `${TRANSLATIONS[state.language].output.powerHeader}\n` +
          `${TRANSLATIONS[state.language].output.powerT1.replace('{power}', powerData.t1.toLocaleString(TRANSLATIONS[state.language].locale))}\n` +
          `${TRANSLATIONS[state.language].output.powerT2.replace('{power}', powerData.t2.toLocaleString(TRANSLATIONS[state.language].locale))}\n` +
          `${TRANSLATIONS[state.language].output.powerT3.replace('{power}', powerData.t3.toLocaleString(TRANSLATIONS[state.language].locale))}\n` +
          `${TRANSLATIONS[state.language].output.powerT4.replace('{power}', powerData.t4.toLocaleString(TRANSLATIONS[state.language].locale))}\n` +
          `${TRANSLATIONS[state.language].output.powerTotal.replace('{power}', powerData.total.toLocaleString(TRANSLATIONS[state.language].locale))}\n` +
          `${TRANSLATIONS[state.language].output.separator}\n`
        );

        return (
          `${TRANSLATIONS[state.language].output.accountHeader.replace('{id}', account.id).replace('{name}', account.name || 'Konto ' + account.id)}\n\n` +
          `${TRANSLATIONS[state.language].output.normalSpeeds}\n` +
          `${TRANSLATIONS[state.language].output.days.replace('{days}', speedResult.days)}\n` +
          `${TRANSLATIONS[state.language].output.hours.replace('{hours}', speedResult.hours)}\n` +
          `${TRANSLATIONS[state.language].output.minutes.replace('{mins}', speedResult.mins)}\n` +
          `${TRANSLATIONS[state.language].output.gems.replace('{gems}', (state.gems[account.id] || 0).toLocaleString(TRANSLATIONS[state.language].locale))}\n` +
          `${TRANSLATIONS[state.language].output.gems15h.replace('{count}', gems_15h.toLocaleString(TRANSLATIONS[state.language].locale))}\n` +
          `${TRANSLATIONS[state.language].output.gems24h.replace('{count}', gems_24h.toLocaleString(TRANSLATIONS[state.language].locale))}\n` +
          `${TRANSLATIONS[state.language].output.separator}\n` +
          `${TRANSLATIONS[state.language].output.trainSpeeds}\n` +
          `${TRANSLATIONS[state.language].output.days.replace('{days}', trainSpeedResult.days)}\n` +
          `${TRANSLATIONS[state.language].output.hours.replace('{hours}', trainSpeedResult.hours)}\n` +
          `${TRANSLATIONS[state.language].output.minutes.replace('{mins}', trainSpeedResult.mins)}\n` +
          `${TRANSLATIONS[state.language].output.separator}\n` +
          Object.keys(unitsData).map(unit => 
            unitsData[unit] > 0 ? `${TRANSLATIONS[state.language].output.missingUnits.replace('{unit}', TRANSLATIONS[state.language].units[unit] || unit).replace('{count}', unitsData[unit].toLocaleString(TRANSLATIONS[state.language].locale))}\n` : ''
          ).join('') +
          `\n${TRANSLATIONS[state.language].output.timestamp.replace('{date}', new Date().toLocaleString(TRANSLATIONS[state.language].locale, { timeZone: 'Europe/Warsaw' }))}\n` +
          `${TRANSLATIONS[state.language].output.separator}\n` +
          (state.barracks[account.id] ? Object.keys(trainingData).map(unit => 
            unitsData[unit] > 0 ? `${TRANSLATIONS[state.language].output.trainings.replace('{unit}', TRANSLATIONS[state.language].units[unit] || unit).replace('{count}', trainingData[unit].toLocaleString(TRANSLATIONS[state.language].locale))}\n` : ''
          ).join('') +
          `\n${TRANSLATIONS[state.language].output.trainingSeparator}\n` : '') +
          unitSpeedsData.content.join('') +
          `${TRANSLATIONS[state.language].output.t1Speeds}\n` +
          `${TRANSLATIONS[state.language].output.days.replace('{days}', timeToDHM(unitSpeedsData.results.t1 * 1440).days)}\n` +
          `${TRANSLATIONS[state.language].output.hours.replace('{hours}', timeToDHM(unitSpeedsData.results.t1 * 1440).hours)}\n` +
          `${TRANSLATIONS[state.language].output.minutes.replace('{mins}', timeToDHM(unitSpeedsData.results.t1 * 1440).mins)}\n` +
          `${TRANSLATIONS[state.language].output.separator}\n` +
          `${TRANSLATIONS[state.language].output.t2Speeds}\n` +
          `${TRANSLATIONS[state.language].output.days.replace('{days}', timeToDHM(unitSpeedsData.results.t2 * 1440).days)}\n` +
          `${TRANSLATIONS[state.language].output.hours.replace('{hours}', timeToDHM(unitSpeedsData.results.t2 * 1440).hours)}\n` +
          `${TRANSLATIONS[state.language].output.minutes.replace('{mins}', timeToDHM(unitSpeedsData.results.t2 * 1440).mins)}\n` +
          `${TRANSLATIONS[state.language].output.separator}\n` +
          `${TRANSLATIONS[state.language].output.t3Speeds}\n` +
          `${TRANSLATIONS[state.language].output.days.replace('{days}', timeToDHM(unitSpeedsData.results.t3 * 1440).days)}\n` +
          `${TRANSLATIONS[state.language].output.hours.replace('{hours}', timeToDHM(unitSpeedsData.results.t3 * 1440).hours)}\n` +
          `${TRANSLATIONS[state.language].output.minutes.replace('{mins}', timeToDHM(unitSpeedsData.results.t3 * 1440).mins)}\n` +
          `${TRANSLATIONS[state.language].output.separator}\n` +
          `${TRANSLATIONS[state.language].output.t4Speeds}\n` +
          `${TRANSLATIONS[state.language].output.days.replace('{days}', timeToDHM(unitSpeedsData.results.t4 * 1440).days)}\n` +
          `${TRANSLATIONS[state.language].output.hours.replace('{hours}', timeToDHM(unitSpeedsData.results.t4 * 1440).hours)}\n` +
          `${TRANSLATIONS[state.language].output.minutes.replace('{mins}', timeToDHM(unitSpeedsData.results.t4 * 1440).mins)}\n` +
          `${TRANSLATIONS[state.language].output.separator}\n` +
          `${TRANSLATIONS[state.language].output.totalSpeeds}\n` +
          `${TRANSLATIONS[state.language].output.days.replace('{days}', timeToDHM((unitSpeedsData.results.t1 + unitSpeedsData.results.t2 + unitSpeedsData.results.t3 + unitSpeedsData.results.t4) * 1440).days)}\n` +
          `${TRANSLATIONS[state.language].output.hours.replace('{hours}', timeToDHM((unitSpeedsData.results.t1 + unitSpeedsData.results.t2 + unitSpeedsData.results.t3 + unitSpeedsData.results.t4) * 1440).hours)}\n` +
          `${TRANSLATIONS[state.language].output.minutes.replace('{mins}', timeToDHM((unitSpeedsData.results.t1 + unitSpeedsData.results.t2 + unitSpeedsData.results.t3 + unitSpeedsData.results.t4) * 1440).mins)}\n` +
          `${TRANSLATIONS[state.language].output.separator}\n` +
          missingSpeedsSection +
          powerSection +
          comparison +
          `\n${TRANSLATIONS[state.language].output.accountSeparator}\n\n`
        );
      });
      state.results = outputs.filter(output => output && typeof output === 'string');
      state.currentStep = 'preview';
      render();
    }

    function downloadResults() {
      if (!state.results || state.results.length === 0) {
        alert(TRANSLATIONS[state.language].downloadError);
        return;
      }

      try {
        if (state.fileOption === 'single') {
          const content = state.results.join('\n');
          const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = state.filePath ? `${state.filePath}.txt` : 'wyniki.txt';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } else {
          state.results.forEach((output, index) => {
            if (!output) return;
            const blob = new Blob([output], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const accountName = state.accounts[index]?.name.replace(/[^a-zA-Z0-9]/g, '') || `konto_${index + 1}`;
            a.href = url;
            a.download = state.filePath ? `${state.filePath}_${accountName}.txt` : `wyniki_${accountName}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          });
        }
      } catch (err) {
        console.error('Błąd podczas pobierania:', err);
        alert(TRANSLATIONS[state.language].downloadError);
      }
    }

    function render() {
      const app = document.getElementById('app');
      const t = TRANSLATIONS[state.language];
      app.innerHTML = '';
      document.getElementById('main-title').textContent = t.mainTitle;

      if (state.currentStep === 'config') {
        app.innerHTML = `
          <div class="mb-6">
            <div class="mb-4">
              <label class="block text-sm font-medium">${t.accountCount}</label>
              <input type="number" min="1" max="10" value="${state.accounts.length}" id="accountCount" class="w-full p-2 border rounded-md">
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium">Język:</label>
              <select id="languageSelect" class="w-full p-2 border rounded">
                <option value="pl" ${state.language === 'pl' ? 'selected' : ''}>Polski</option>
                <option value="en" ${state.language === 'en' ? 'selected' : ''}>English</option>
                <option value="es" ${state.language === 'es' ? 'selected' : ''}>Español</option>
                <option value="de" ${state.language === 'de' ? 'selected' : ''}>Deutsch</option>
                <option value="fr" ${state.language === 'fr' ? 'selected' : ''}>Français</option>
              </select>
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium">${t.uploadOption}</label>
              <select id="uploadOption" class="w-full p-2 border rounded-md">
                <option value="single" ${state.uploadOption === 'single' ? 'selected' : ''}>${t.singleUpload}</option>
                <option value="multiple" ${state.uploadOption === 'multiple' ? 'selected' : ''}>${t.multipleUpload}</option>
              </select>
              <label class="block text-sm font-medium mt-2">${t.uploadFile}</label>
              <input type="file" accept=".txt" id="fileUpload" ${state.uploadOption === 'multiple' ? 'multiple' : ''} class="w-full">
              ${state.uploadError ? `<p class="text-red-500 text-sm mt-2">${state.uploadError}</p>` : ''}
            </div>
            ${state.accounts.map(account => `
              <div class="mb-4 p-4 border rounded-md">
                <label class="block text-sm font-medium">${t.accountName.replace('{count}', account.id)}</label>
                <input type="text" value="${account.name}" id="account-${account.id}" class="w-full p-2 border rounded-md mb-2">
                <h3 class="text-lg font-semibold">${t.targetUnits}</h3>
                ${Object.keys(UNIT_REQUIREMENTS_DEFAULT).map(unit => `
                  <div class="flex items-center mb-2">
                    <img src="${DEFAULT_IMAGES[unit]}" alt="${unit}" class="w-8 h-8 mr-2 rounded">
                    <label class="text-sm font-medium mr-2">${t.units[unit]}:</label>
                    <input type="number" value="${account.requirements[unit]}" id="unit-${account.id}-${unit}" min="0" class="w-full p-2 border rounded-md">
                  </div>
                `).join('')}
              </div>
            `).join('')}
            <button id="add-account" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">${t.addAccount}</button>
            <div class="mt-4">
              <label class="block text-sm font-medium">${t.fileSaving}</label>
              <select id="fileOption" class="w-full p-2 border rounded-md mb-2">
                <option value="single" ${state.fileOption === 'single' ? 'selected' : ''}>${t.singleFile}</option>
                <option value="multiple" ${state.fileOption === 'multiple' ? 'selected' : ''}>${t.multipleFiles}</option>
              </select>
              <label class="block text-sm font-medium">${t.fileName}</label>
              <input type="text" value="${state.filePath}" id="filePath" placeholder="${t.filePlaceholder}" class="w-full p-2 border rounded-md">
            </div>
            <button id="nextConfig" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">${t.next}</button>
          </div>
        `;
        document.getElementById('accountCount').addEventListener('change', (e) => {
          const count = parseInt(e.target.value) || 1;
          const newAccounts = Array.from({ length: Math.min(count, 10) }, (_, i) => (
            state.accounts[i] || { id: `${i + 1}`, name: `Konto ${i + 1}`, requirements: { ...UNIT_REQUIREMENTS_DEFAULT } }
          ));
          state.accounts = newAccounts;
          render();
        });
        document.getElementById('languageSelect').addEventListener('change', (e) => {
          state.language = e.target.value;
          render();
        });
        document.getElementById('uploadOption').addEventListener('change', (e) => {
          state.uploadOption = e.target.value;
          render();
        });
        document.getElementById('fileUpload').addEventListener('change', handleFileUpload);
        state.accounts.forEach(account => {
          document.getElementById(`account-${account.id}`).addEventListener('change', (e) => {
            state.accounts = state.accounts.map(acc => acc.id === account.id ? { ...acc, name: e.target.value } : acc);
            render();
          });
          Object.keys(UNIT_REQUIREMENTS_DEFAULT).forEach(unit => {
            document.getElementById(`unit-${account.id}-${unit}`).addEventListener('change', (e) => {
              state.accounts = state.accounts.map(acc => acc.id === account.id ? {
                ...acc,
                requirements: { ...acc.requirements, [unit]: parseInt(e.target.value) || 0 }
              } : acc);
              render();
            });
          });
        });
        document.getElementById('add-account').addEventListener('click', () => {
          state.accounts.push({ id: `${state.accounts.length + 1}`, name: `Konto ${state.accounts.length + 1}`, requirements: { ...UNIT_REQUIREMENTS_DEFAULT } });
          render();
        });
        document.getElementById('fileOption').addEventListener('change', (e) => {
          state.fileOption = e.target.value;
          render();
        });
        document.getElementById('filePath').addEventListener('change', (e) => {
          state.filePath = e.target.value;
          render();
        });
        document.getElementById('nextConfig').addEventListener('click', () => {
          state.currentStep = 'speeds';
          render();
        });
      } else if (state.currentStep === 'speeds') {
        app.innerHTML = `
          <div class="mb-6">
            <h2 class="text-xl font-semibold mb-4">${t.speedsTitle}</h2>
            <div class="mb-4 p-4 border rounded-md">
              ${state.accounts.map(account => `
                <div class="mb-4">
                  <h3 class="text-lg font-semibold mb-2">${account.name}</h3>
                  ${Object.keys(SPEED_TIMES).map(speed => `
                    <div class="flex items-center mb-2">
                      <img src="${DEFAULT_IMAGES[speed]}" alt="${speed}" class="w-8 h-8 mr-2 rounded">
                      <label class="text-sm font-medium mr-2">${t.speedLabel.replace('{speed}', speed)}</label>
                      <input type="number" value="${state.speeds[account.id]?.[speed] || ''}" id="speed-${account.id}-${speed}" min="0" class="w-64 p-2 border rounded-md">
                    </div>
                  `).join('')}
                  <label class="block text-sm font-medium mb-1">${t.gemsLabel}</label>
                  <input type="number" value="${state.gems[account.id] || ''}" id="gems-${account.id}" min="0" class="w-full p-2 border rounded-md">
                </div>
              `).join('')}
            </div>
            <button id="nextSpeeds" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">${t.next}</button>
            <button id="backSpeeds" class="mt-4 ml-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">${t.back}</button>
          </div>
        `;
        state.accounts.forEach(account => {
          Object.keys(SPEED_TIMES).forEach(speed => {
            document.getElementById(`speed-${account.id}-${speed}`).addEventListener('change', (e) => {
              state.speeds[account.id] = { ...state.speeds[account.id], [speed]: parseInt(e.target.value) || 0 };
              render();
            });
          });
          document.getElementById(`gems-${account.id}`).addEventListener('change', (e) => {
            state.gems[account.id] = parseInt(e.target.value) || 0;
            render();
          });
        });
        document.getElementById('nextSpeeds').addEventListener('click', () => {
          state.currentStep = 'trainSpeeds';
          render();
        });
        document.getElementById('backSpeeds').addEventListener('click', () => {
          state.currentStep = 'config';
          render();
        });
      } else if (state.currentStep === 'trainSpeeds') {
        app.innerHTML = `
          <div class="mb-6">
            <h2 class="text-xl font-semibold mb-4">${t.trainSpeedsTitle}</h2>
            <div class="mb-4 p-4 border rounded-md">
              ${state.accounts.map(account => `
                <div class="mb-4">
                  <h3 class="text-lg font-semibold mb-2">${account.name}</h3>
                  ${Object.keys(SPEED_TIMES).map(speed => `
                    <div class="flex items-center mb-2">
                      <img src="${DEFAULT_IMAGES[speed]}" alt="${speed}" class="w-8 h-8 mr-2 rounded">
                      <label class="text-sm font-medium mr-2">${t.speedLabel.replace('{speed}', speed)}</label>
                      <input type="number" min="0" value="${state.trainSpeeds[account.id]?.[speed] || ''}" id="trainSpeed-${account.id}-${speed}" class="w-64 p-2 border rounded-md">
                    </div>
                  `).join('')}
                </div>
              `).join('')}
            </div>
            <button id="nextTrainSpeeds" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">${t.next}</button>
            <button id="backTrainSpeeds" class="mt-4 ml-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">${t.back}</button>
          </div>
        `;
        state.accounts.forEach(account => {
          Object.keys(SPEED_TIMES).forEach(speed => {
            document.getElementById(`trainSpeed-${account.id}-${speed}`).addEventListener('change', (e) => {
              state.trainSpeeds[account.id] = { ...state.trainSpeeds[account.id], [speed]: parseInt(e.target.value) || 0 };
              render();
            });
          });
        });
        document.getElementById('nextTrainSpeeds').addEventListener('click', () => {
          state.currentStep = 'units';
          render();
        });
        document.getElementById('backTrainSpeeds').addEventListener('click', () => {
          state.currentStep = 'speeds';
          render();
        });
      } else if (state.currentStep === 'units') {
        app.innerHTML = `
          <div class="mb-6">
            <h2 class="text-xl font-semibold mb-4">${t.unitsTitle}</h2>
            <div class="mb-4 p-4 border rounded-md">
              ${state.accounts.map(account => `
                <div class="mb-4">
                  <h3 class="text-lg font-semibold mb-2">${account.name}</h3>
                  ${Object.keys(UNIT_REQUIREMENTS_DEFAULT).map(unit => `
                    <div class="flex items-center mb-2">
                      <img src="${DEFAULT_IMAGES[unit]}" alt="${unit}" class="w-8 h-8 mr-2 rounded">
                      <label class="text-sm font-medium mr-2">${t.unitInput.replace('{unit}', t.units[unit])}</label>
                      <input type="number" min="0" value="${state.units[account.id]?.[unit] || ''}" id="unit-${account.id}-${unit}" class="w-64 p-2 border rounded-md">
                    </div>
                  `).join('')}
                </div>
              `).join('')}
            </div>
            <button id="nextUnits" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">${t.next}</button>
            <button id="backUnits" class="mt-4 ml-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">${t.back}</button>
          </div>
        `;
        state.accounts.forEach(account => {
          Object.keys(UNIT_REQUIREMENTS_DEFAULT).forEach(unit => {
            document.getElementById(`unit-${account.id}-${unit}`).addEventListener('change', (e) => {
              state.units[account.id] = { ...state.units[account.id], [unit]: parseInt(e.target.value) || 0 };
              render();
            });
          });
        });
        document.getElementById('nextUnits').addEventListener('click', () => {
          state.currentStep = 'training';
          render();
        });
        document.getElementById('backUnits').addEventListener('click', () => {
          state.currentStep = 'trainSpeeds';
          render();
        });
      } else if (state.currentStep === 'training') {
        app.innerHTML = `
          <div class="mb-6">
            <h2 class="text-xl font-semibold mb-4">${t.trainingTitle}</h2>
            <div class="mb-4 p-4 border rounded-md">
              ${state.accounts.map(account => `
                <div class="mb-4">
                  <h3 class="text-lg font-semibold mb-2">${account.name}</h3>
                  <label for="barracks-${account.id}" class="block text-sm font-medium mb-1">${t.barracksLabel.replace('{account}', account.name)}</label>
                  <input type="number" min="0" value="${state.barracks[account.id] || ''}" id="barracks-${account.id}" class="w-full p-2 border rounded-md mb-2">
                  <label for="boost-${account.id}" class="block text-sm font-medium mb-1">${t.boostLabel.replace('{account}', account.name)}</label>
                  <input type="text" value="${state.boost[account.id] || ''}" id="boost-${account.id}" class="w-full p-2 border rounded-md">
                </div>
              `).join('')}
            </div>
            <button id="nextTraining" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">${t.next}</button>
            <button id="backTraining" class="mt-4 ml-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">${t.back}</button>
          </div>
        `;
        state.accounts.forEach(account => {
          document.getElementById(`barracks-${account.id}`).addEventListener('change', (e) => {
            state.barracks[account.id] = e.target.value;
            render();
          });
          document.getElementById(`boost-${account.id}`).addEventListener('change', (e) => {
            state.boost[account.id] = e.target.value;
            render();
          });
        });
        document.getElementById('nextTraining').addEventListener('click', () => {
          if (validateTrainingInputs()) {
            generateOutput();
          }
        });
        document.getElementById('backTraining').addEventListener('click', () => {
          state.currentStep = 'units';
          render();
        });
      } else if (state.currentStep === 'preview') {
        app.innerHTML = `
          <div class="mb-6">
            <h2 class="text-xl font-semibold mb-4">${t.previewTitle}</h2>
            <div class="mb-4 p-4 border rounded-md">
              ${state.results.map((result, index) => `
                <div class="mb-4">
                  <h3 class="text-lg font-semibold mb-2">${state.accounts[index]?.name || `Konto ${index + 1}`}</h3>
                  <pre class="whitespace-pre-wrap text-sm text-gray-800 bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-sm">${result}</pre>
                </div>
              `).join('')}
            </div>
            <button id="downloadResults" class="mt-4 bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition duration-200">${t.downloadResults}</button>
            <button id="backPreview" class="mt-4 ml-4 bg-gray-600 text-white px-5 py-2 rounded-lg hover:bg-gray-700 transition duration-200">${t.back}</button>
          </div>
        `;
        document.getElementById('downloadResults').addEventListener('click', downloadResults);
        document.getElementById('backPreview').addEventListener('click', () => {
          state.currentStep = 'training';
          render();
        });
      }
    }

    render();
  </script>
</body>
</html>
